from datetime import datetime
import joblib
import pandas as pd
from app_logging.logging import App_Logger
from data_loading.data_loader import Data_load
from data_preprocessing.preprocessing import Preprocessor
from model_find.model_dispatcher import Make_model
from Evaluating_model.eval import Evaluation

if __name__ == "__main__":
    file_object = open("Logs/log.txt", 'a+')
    log_writer = App_Logger()
    try:
        data_get = Data_load(file_object, log_writer)
        log_writer.log(file_object, "\n")
        data = data_get.get_data()
        preprocess = Preprocessor(file_object, log_writer)
        data = preprocess.encodeCatFeature(data)
        data = preprocess.clean(data)
        null_col = preprocess.check_null(data)
        if len(null_col) != 0:
            data.dropna(inplace=True)
        data.to_csv('data/data_preprocessed.csv')
        X = data.drop(['class'], axis=1)
        y = data['class']

        X_train, X_test, y_train, y_test = preprocess.split(X, y)
        make_model = Make_model(file_object, log_writer)
        make_model.best_model_ensemble(X_train, y_train)
        load_model = joblib.load(open('model_find/extra_tree.sav', 'rb'))
        result = load_model.score(X_test, y_test)
        log_writer.log(file_object, "Result of model "+str(result))
        evv = Evaluation(file_object, log_writer)
        evv.best_model_dnn(X_test, y_test)
        log_writer.log(file_object, "Success in task !!")
        file_object.close()
    except Exception as e:
        log_writer.log(file_object, "Failure "+ str(e))
        file_object.close()
        raise Exception